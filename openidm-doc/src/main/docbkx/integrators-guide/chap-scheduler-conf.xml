<?xml version="1.0" encoding="UTF-8"?>
<!--
  ! CCPL HEADER START
  !
  ! This work is licensed under the Creative Commons
  ! Attribution-NonCommercial-NoDerivs 3.0 Unported License.
  ! To view a copy of this license, visit
  ! http://creativecommons.org/licenses/by-nc-nd/3.0/
  ! or send a letter to Creative Commons, 444 Castro Street,
  ! Suite 900, Mountain View, California, 94041, USA.
  !
  ! You can also obtain a copy of the license at
  ! legal/CC-BY-NC-ND.txt.
  ! See the License for the specific language governing permissions
  ! and limitations under the License.
  !
  ! If applicable, add the following below this CCPL HEADER, with the fields
  ! enclosed by brackets "[]" replaced with your own identifying information:
  !      Portions Copyright [yyyy] [name of copyright owner]
  !
  ! CCPL HEADER END
  !
  !      Copyright 2011-2012 ForgeRock AS
  !    
-->
<chapter xml:id='chap-scheduler-conf'
 xmlns='http://docbook.org/ns/docbook'
 version='5.0' xml:lang='en'
 xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance'
 xsi:schemaLocation='http://docbook.org/ns/docbook http://docbook.org/xml/5.0/xsd/docbook.xsd'
 xmlns:xlink='http://www.w3.org/1999/xlink'
 xmlns:xinclude='http://www.w3.org/2001/XInclude'>
 <title>Scheduling Tasks and Events</title>
 <indexterm>
  <primary>Scheduler</primary>
 </indexterm>
  <indexterm>
  <primary>Scheduling tasks</primary>
 </indexterm>
 
  <para>OpenIDM enables you to schedule reconciliation and synchronization 
  tasks. You can also use scheduling to trigger scripts, collect and run 
  reports, trigger workflows, perform custom logging, and so forth.</para>

 <para>OpenIDM supports <command>cron</command>-like syntax to schedule events
 and tasks, based on expressions supported by the Quartz Scheduler (bundled 
 with OpenIDM).</para>

 <para>If you use configuration files to schedule tasks and events, you must 
 place the schedule files in the <filename>openidm/conf</filename> directory.
 By convention, OpenIDM uses file names of the form
 <filename>schedule-<replaceable>schedule-name</replaceable>.json</filename>, 
 where <replaceable>schedule-name</replaceable> is a logical name for the 
 scheduled operation, for example, 
 <filename>schedule-reconcile_systemXmlAccounts_managedUser.json</filename>. 
 There are several example schedule configuration files in the 
 <filename>openidm/samples/schedules</filename> directory.</para>
 
 <para>You can configure OpenIDM to pick up changes to scheduled tasks and 
 events dynamically, during initialization and also at runtime. For more 
 information, see <link xlink:href="integrators-guide#when-configuring-notes" 
 xlink:role="http://docbook.org/xlink/role/olink"><citetitle>Changing the 
 Configuration</citetitle></link>.</para>
 
 <section xml:id="scheduler-configuration-file">
  <title>Scheduler Configuration</title>
  <indexterm>
   <primary>Scheduler</primary>
   <secondary>Configuration</secondary>
  </indexterm>
 
 <itemizedlist>
  <para>Schedules are configured through JSON objects. The schedule 
  configuration involves two types of files:</para>
  <listitem><para>The <filename>openidm/conf/scheduler.json</filename> file, 
  that configures the overall scheduler service</para></listitem>
  <listitem><para>One <filename>openidm/conf/schedule-
 <replaceable>schedule-name</replaceable>.json</filename> file for each 
 configured schedule.</para></listitem>
 </itemizedlist>
 
  <para>The scheduler service configuration file 
  (<filename>openidm/conf/scheduler.json</filename>) has the following format:</para>
  
  <programlisting language='javascript'>
  {
    "threadPool" : {
        "threadCount" : "10"
    },
    "scheduler" : {
        "instanceId" : "scheduler-example"
    },
    "advancedProperties" : {
        "org.quartz.scheduler.instanceName" : "OpenIDMScheduler"
    }
  }
  </programlisting>
  
  <itemizedlist>
   <para>The properties in the <filename>scheduler.json</filename> file relate 
   to the configuration of the Quartz Scheduler.</para>
   <listitem><para><literal>threadCount</literal> specifies the maximum number 
   of threads that are available for the concurrent execution of scheduled 
   tasks.</para>
   </listitem>
   <listitem><para><literal>instanceID</literal> can be any string, but must be 
   unique for all schedulers working as if they are the same 'logical' Scheduler 
   within a cluster.</para></listitem>
   <listitem><para><literal>advancedProperties</literal> (optional) enables you 
   to configure additional properties for the Quartz Scheduler.</para></listitem>
  </itemizedlist>
  
  <para>For details of all the configurable properties for the Quartz Scheduler, 
  see the <link xlink:show="new" 
  xlink:href="http://www.quartz-scheduler.org/documentation/quartz-2.1.x/configuration/ConfigMain"
  ><citetitle>Quartz Scheduler Configuration Reference</citetitle></link>.</para>
 
  <para>Each schedule configuration file, <filename>openidm/conf/schedule-
  <replaceable>schedule-name</replaceable>.json</filename> has the following 
  format:</para>

  <programlisting language="javascript">
{
 "enabled"       : true,
 "persisted"     : false,
 "type"          : "cron",
 "startTime"     : "<replaceable>(optional) time</replaceable>",
 "endTime"       : "<replaceable>(optional) time</replaceable>",
 "schedule"      : "<replaceable>cron expression</replaceable>",
 "misfirePolicy" : "<replaceable>optional, string</replaceable>",
 "timeZone"      : "<replaceable>(optional) time zone</replaceable>",
 "invokeService" : "<replaceable>service identifier</replaceable>",
 "invokeContext" : "<replaceable>service specific context info</replaceable>"
}</programlisting>

 <variablelist>
  <para>The schedule configuration properties are defined as follows:</para>
  <varlistentry>
   <term>enabled</term>
   <listitem>
    <para>Set to <literal>true</literal> to enable the schedule. When this 
    property is set to <literal>false</literal>, OpenIDM considers the 
    schedule configuration dormant, and does not allow it to be triggered or
    executed.</para>
    <para>If you want to retain a schedule configuration, but do not want it 
    used, set <literal>enabled</literal> to <literal>false</literal> for task 
    and event schedulers, instead of changing the configuration or 
    <command>cron</command> expressions.</para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term>persisted (optional)</term>
   <listitem>
    <para>Specifies whether the schedule state should be persisted or stored 
    in RAM. Boolean (<literal>true</literal> or <literal>false</literal>), 
    <literal>false</literal> by default. For more information, see 
    <xref linkend="persistent-schedules"/>.</para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term>type</term>
   <listitem>
    <para>Currently OpenIDM supports only <literal>cron</literal>.</para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term>startTime (optional)</term>
   <listitem>
    <para>Used to start the schedule at some time in the future. If this 
    parameter is omitted, empty, or set to a time in the past, the task or 
    event is scheduled to start immediately.</para>
    <para>Use ISO 8601 format to specify times and dates (<literal><replaceable>
    YYYY</replaceable>-<replaceable>MM</replaceable>-<replaceable>DD
    </replaceable>T<replaceable>hh</replaceable>:<replaceable>mm
    </replaceable>:<replaceable>ss</replaceable></literal>).</para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term>endTime (optional)</term>
   <listitem>
    <para>Used to plan the end of scheduling.</para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term>schedule</term>
   <listitem>
    <para>Takes <command>cron</command> expression syntax. For more information, 
    see the <link xlink:show="new"
    xlink:href="http://www.quartz-scheduler.org/docs/tutorials/crontrigger.html"
    ><citetitle>CronTrigger Tutorial</citetitle></link> and <link
    xlink:href="http://www.quartz-scheduler.org/docs/tutorial/TutorialLesson06.html"
    xlink:show="new"><citetitle>Lesson 6: CronTrigger</citetitle></link>.</para>  
   </listitem>
  </varlistentry>
  <varlistentry>
   <term>misfirePolicy (optional)</term>
   <listitem>
    <para>For persistent schedules, specifies the behavior if the scheduled 
    task is missed, for some reason. Possible values are as follows:
    </para>
    <itemizedlist>
     <listitem><para><literal>fireAndProceed</literal>. The first execution 
     of a missed schedule is immediately executed when the server is back 
     online. Subsequent executions are discarded. After this, the normal 
     schedule is resumed.</para></listitem>
     <listitem><para><literal>doNothing</literal>, all missed schedules are 
     discarded and the normal schedule is resumed when the server is back 
     online.</para></listitem>
    </itemizedlist>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term>timeZone (optional)</term>
   <listitem>
    <para>If not set, OpenIDM uses the system time zone.</para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term>invokeService</term>
   <listitem>
    <para>Defines the type of scheduled event or action. The value of this 
    parameter can be one of the following:</para>
    <itemizedlist>
     <listitem><para><literal>"sync"</literal> for reconciliation</para></listitem>
     <listitem><para><literal>"provisioner"</literal> for LiveSync</para></listitem>
     <listitem><para><literal>"script"</literal> to call some other scheduled 
       operation defined in a script</para></listitem>
    </itemizedlist>
   </listitem>   
  </varlistentry>
  <varlistentry>
   <term>invokeContext</term>
   <listitem>
    <para>Specifies contextual information, depending on the type of scheduled 
    event (the value of the <literal>invokeService</literal> parameter).
    </para>
    <para>The following example invokes reconciliation.</para>
    <programlisting language="javascript">
{
    "invokeService": "sync",
    "invokeContext": {
        "action": "reconcile",
        "mapping": "systemLdapAccount_managedUser"
    }
}</programlisting>
  
  <itemizedlist>
   <para>For a scheduled reconciliation task, you can define the mapping 
   in one of two ways:</para>
   <listitem>
    <para>Reference a mapping by its name in <filename>sync.json</filename>,
    as shown in the previous example. The mapping must exist in the
    <filename>openidm/conf/sync.json</filename> file.</para></listitem>
   <listitem>
    <para>Add the mapping definition inline by using the
    <literal>"mapping"</literal> property, as shown in the example in
    <link xlink:href="integrators-guide#alternative-mapping"
    xlink:role="http://docbook.org/xlink/role/olink"><citetitle>Alternative
    Mappings</citetitle></link>.</para>
   </listitem>
  </itemizedlist>
    
    <para>The following example invokes a LiveSync action.</para>
    <programlisting language="javascript">
{
    "invokeService": "provisioner",
    "invokeContext": {
        "action": "liveSync",
        "source": "system/OpenDJ/__ACCOUNT__"
    }
}</programlisting>

  <para>For scheduled LiveSync tasks, the <literal>"source"</literal> property 
  follows OpenIDM's convention for a pointer to an external resource object 
  and takes the form <literal>system/<replaceable>resource-name</replaceable>
  /<replaceable>object-type</replaceable></literal>.</para>

  <para>The following example invokes a script, which prints the string 
  <literal>Hello World</literal> to the OpenIDM log 
  (<filename>/openidm/logs/openidm0.log.X</filename>) each minute.</para>

  <programlisting language="javascript">
{
    "invokeService": "script",
    "invokeContext": {
        "script": {
            "type": "text/javascript",
            "source": "java.lang.System.out.println('Hello World’);"
        },
    }
}</programlisting>

    <para>Note that these are sample configurations only. Your own schedule 
    configuration will differ according to your specific requirements.</para>
   </listitem>
  </varlistentry>
 </variablelist>

 </section>

 <section xml:id="persistent-schedules">
  <title>Configuring Persistent Schedules</title>
  <para>By default, scheduling information, such as schedule state and details 
  of the schedule execution, is stored in RAM. This means that such 
  information is lost when OpenIDM is rebooted. The schedule configuration 
  itself (defined in the <filename>openidm/conf/schedule-
  <replaceable>schedule-name</replaceable>.json</filename> file) is not lost 
  when OpenIDM is shut down, and normal scheduling continues when the server is 
  restarted. However, there are no details of missed schedule executions that 
  should have occurred during the period the server was unavailable.</para>
  <para>You can configure schedules to be persistent, which means that the 
  scheduling information is stored in the internal repository rather than in 
  RAM. With persistent schedules, scheduling information is retained when OpenIDM 
  is shut down. Any previously scheduled jobs can be rescheduled automatically 
  when OpenIDM is restarted.</para>
  <para>Persistent schedules also enable you to manage scheduling across a 
  cluster (multiple OpenIDM instances). When scheduling is persistent, a 
  particular schedule will be executed only once across the cluster, rather than 
  once on every OpenIDM instance. For example, if your deployment includes a 
  cluster of OpenIDM nodes for high availability, you can use persistent 
  scheduling to start a reconciliation action on only one node in the cluster, 
  instead of starting several competing reconciliation actions on each node.</para>
  <para>You can use persistent schedules with the default OrientDB repository, 
  or with the MySQL repository (see <link xlink:href="install-guide#chap-repository"
    xlink:role="http://docbook.org/xlink/role/olink"><citetitle>Installing a 
    Repository For Production</citetitle></link>).
  </para>
  <para>To configure persistent schedules, set the <literal>"persisted"</literal> 
  property to <literal>true</literal> in the schedule configuration file 
  (<filename>schedule-<replaceable>schedule-name</replaceable>.json)</filename>.
  </para>
  <para>If OpenIDM is down when a scheduled task was set to occur, one or more 
  executions of that schedule might be missed. To specify what action should be 
  taken if schedules are missed, set the <literal>misfirePolicy</literal> in the 
  schedule configuration file. The <literal>misfirePolicy</literal> determines 
  what OpenIDM should do if scheduled tasks are missed. Possible values are as 
  follows:
    </para>
    <itemizedlist>
     <listitem><para><literal>fireAndProceed</literal>. The first execution of 
     a missed schedule is immediately executed when the server is back online. 
     Subsequent executions are discarded. After this, the normal schedule is 
     resumed.</para></listitem>
     <listitem><para><literal>doNothing</literal>. All missed schedules are 
     discarded and the normal schedule is resumed when the server is back 
     online.</para></listitem>
    </itemizedlist>
  </section>

 <section xml:id="scheduler-examples">
  <title>Schedule Examples</title>
  <indexterm>
   <primary>Schedule</primary>
   <secondary>Examples</secondary>
  </indexterm>

  <para>The following example shows a schedule for reconciliation that
  is not enabled. When enabled (<literal>"enabled" : true,</literal>),
  reconciliation runs every 30 minutes, starting on the hour.</para>

  <programlisting language="javascript">
{
    "enabled": false,
    "persisted": false,
    "type": "cron",
    "schedule": "0 0/30 * * * ?",
    "invokeService": "sync",
    "invokeContext": {
        "action": "reconcile",
        "mapping": "systemLdapAccounts_managedUser"
    }
}</programlisting>

  <para>The following example shows a schedule for LiveSync enabled to run 
  every 15 seconds, starting at the beginning of the minute. The schedule is 
  persisted, that is, stored in the internal repository rather than in memory. 
  If one or more LiveSync executions are missed, as a result of OpenIDM being 
  unavailable, the first execution of the LiveSync action is executed when the 
  server is back online. Subsequent executions are discarded. After this, the 
  normal schedule is resumed.</para>

  <programlisting language="javascript">
{
    "enabled": false,
    "persisted": true,
    "misfirePolicy" : "fireAndProceed",
    "type": "cron",
    "schedule": "0/15 * * * * ?",
    "invokeService": "provisioner",
    "invokeContext": {
        "action": "liveSync",
        "source": "system/ldap/account"
    }
}</programlisting>

 </section>
 
 <section xml:id="check-quartz-updates">
  <title>Checking For Quartz Updates</title>

  <para>The Quartz Scheduler can check for updates over the Internet on the
  Quartz project website, and report available updates in the OpenIDM log.
  The option is set in <filename>openidm/conf/system.properties</filename>
  By default, this option is turned off, and should remain off in
  production.</para>

  <literallayout class="monospaced">system.properties:org.quartz.scheduler.skipUpdateCheck = true</literallayout>
 </section>
 
 <section xml:id="scheduler-service-implementations">
  <title>Service Implementer Notes</title>

  <para>Services that can be scheduled implement
  <literal>ScheduledService</literal>. The service PID is used as a basis for
  the service identifier in schedule definitions.</para>
 </section>
 
</chapter>
