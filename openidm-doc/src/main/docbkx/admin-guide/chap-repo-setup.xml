<?xml version="1.0" encoding="UTF-8"?>
<!--
  ! CCPL HEADER START
  !
  ! This work is licensed under the Creative Commons
  ! Attribution-NonCommercial-NoDerivs 3.0 Unported License.
  ! To view a copy of this license, visit
  ! http://creativecommons.org/licenses/by-nc-nd/3.0/
  ! or send a letter to Creative Commons, 444 Castro Street,
  ! Suite 900, Mountain View, California, 94041, USA.
  !
  ! You can also obtain a copy of the license at
  ! legal/CC-BY-NC-ND.txt.
  ! See the License for the specific language governing permissions
  ! and limitations under the License.
  !
  ! If applicable, add the following below this CCPL HEADER, with the fields
  ! enclosed by brackets "[]" replaced with your own identifying information:
  !      Portions Copyright [yyyy] [name of copyright owner]
  !
  ! CCPL HEADER END
  !
  !      Copyright 2011 ForgeRock AS
  !    
-->
<chapter xml:id='chap-repo-setup'
 xmlns='http://docbook.org/ns/docbook'
 version='5.0' xml:lang='en'
 xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance'
 xsi:schemaLocation='http://docbook.org/ns/docbook http://docbook.org/xml/5.0/xsd/docbook.xsd'
 xmlns:xlink='http://www.w3.org/1999/xlink'
 xmlns:xinclude='http://www.w3.org/2001/XInclude'>
 <title>Setting Up the Repository</title>

 <para>OpenIDM is configured by default to leverage the embedded NoSQL repository based on OrientDB,
however configuring OpenIDM to use a relational database as a repository is possible too.</para>


 <section xml:id="orientdb-configuration-id">
  <title>OrientDB configuration</title>
 <para>No extra setup is needed to connect to the built in OrientDB which will automatically start and stop with starting and stopping the OpenIDM process.</para>
 
  <para>This should be share with the install guide!!! ... TODO.</para>
  
  <para>Due to a current limitation in OrientDB it was decided to split the links into different classes. These classes need to be defined in the configuration file <filename>openidm/conf/repo.orientdb.json</filename>.</para>
  <para>The file needs to have an index definition for each mapping of the <filename>openidm/conf/sync.json</filename>. An example link definition is show below:</para>
  <example>
   <programlisting>
"link_systemLdapAccounts_managedUser" : {
    "index" : [
        { "propertyName": "_openidm_id", "propertyType": "string", "indexType": "unique" },
        {"propertyName" : "sourceId", "propertyType" : "string", "indexType" : "unique"},
        {"propertyName" : "targetId", "propertyType" : "string", "indexType" : "unique"},
        {"propertyName" : "reconId", "propertyType" : "string", "indexType" : "notunique"}
    ]
},   
   </programlisting>
  </example>
  <para><filename>"link_systemLdapAccounts_managedUser"</filename> is the result of concatenating the string <filename>"link_"</filename> with the name of the mapping, <filename>"systemLdapAccounts_managedUser"</filename> in this case.</para>
 </section>
 <section xml:id="mysql-setup-id"><title>Setting up OpenIDM with MySQL</title>
  <para>Using OpenIDM with a MySQL database can be done by following this procedure:</para>
  <itemizedlist>
   <listitem><para>Get rid of <filename>repo.orientdb.json in openidm/conf/</filename></para></listitem> 
   <listitem><para>Copy the latest mysql java connector in <filename>openidm/bundle/</filename></para></listitem> 
   <listitem><para>Get the repo.jdbc.json from <filename>openidm/samples/</filename></para></listitem>
   <listitem><para>Import DDL form <filename>openidm/db/scripts/mysql/openidm.sql</filename> to your MySQL DB</para></listitem>
   <listitem><para>Eventually create a db user on mysql and grant it the needed rights</para></listitem>
   <listitem><para>Update the db connection params (login/password...) in the repo.jdbc.json</para></listitem>
  </itemizedlist>
  <example>
   <programlisting>
    "connection" : {
        "dbType" : "MYSQL",
        "jndiName" : "",
        "driverClass" : "com.mysql.jdbc.Driver",
        "jdbcUrl" : "jdbc:mysql://localhost:3306/openidm",
        "username" : "root",
        "password" : "",
        "defaultCatalog" : "openidm",
        "maxBatchSize" : 100,
        "maxTxRetry" : 5
    },
   </programlisting>
  </example>

   
 </section>
 <section xml:id="db2-setup-id">
  <title>Setting Up OpenIDM with DB2</title>
  <para>TODO</para>
 </section>
</chapter>
